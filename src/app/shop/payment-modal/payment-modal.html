@if (isOpen && product) {
    <div class="payment-modal-backdrop" (click)="closeModal()">
        <div class="payment-modal-container" (click)="$event.stopPropagation()">
            <button class="modal-close" (click)="closeModal()" aria-label="Close">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>

            @if (!paymentSuccess()) {
                <div class="modal-header">
                    <h2>Presentear com</h2>
                    <div class="product-info">
                        <img [src]="product.image" [alt]="product.name">
                        <div class="product-details">
                            <h3>{{ product.name }}</h3>
                            <p class="product-price">R$ {{ product.salePrice.toFixed(2) }}</p>
                        </div>
                    </div>
                </div>

                <div class="modal-body">
                    <div class="payment-method-selector">
                        <button
                            class="payment-method-btn"
                            [class.active]="selectedPaymentMethod() === 'pix'"
                            (click)="selectPaymentMethod('pix')">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                            </svg>
                            PIX
                        </button>
                        <button
                            class="payment-method-btn"
                            [class.active]="selectedPaymentMethod() === 'credit-card'"
                            (click)="selectPaymentMethod('credit-card')">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="5" width="20" height="14" rx="2"></rect>
                                <line x1="2" y1="10" x2="22" y2="10"></line>
                            </svg>
                            Cartão de Crédito
                        </button>
                    </div>

                    <!-- PIX Payment -->
                    @if (selectedPaymentMethod() === 'pix') {
                        <div class="payment-content pix-content">
                            <div class="pix-info">
                                <h3>Pague com PIX</h3>
                                <p>Escaneie o QR Code ou copie a chave PIX abaixo:</p>
                            </div>

                            <div class="qr-code-container">
                                <div class="qr-code-placeholder">
                                    <svg width="200" height="200" viewBox="0 0 200 200">
                                        <rect width="200" height="200" fill="#f0f0f0"/>
                                        <text x="100" y="100" text-anchor="middle" fill="#666" font-size="14">QR CODE</text>
                                    </svg>
                                </div>
                            </div>

                            <div class="pix-key-container">
                                <input
                                    type="text"
                                    [value]="pixKey"
                                    readonly
                                    class="pix-key-input">
                                <button
                                    class="copy-btn"
                                    (click)="copyPixKey()"
                                    [class.copied]="pixCopied()">
                                    @if (pixCopied()) {
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                        Copiado!
                                    } @else {
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                        </svg>
                                        Copiar Chave
                                    }
                                </button>
                            </div>

                            <div class="pix-instructions">
                                <h4>Instruções:</h4>
                                <ol>
                                    <li>Abra o app do seu banco</li>
                                    <li>Escolha a opção PIX</li>
                                    <li>Escaneie o QR Code ou cole a chave PIX</li>
                                    <li>Confirme o pagamento</li>
                                </ol>
                            </div>
                        </div>
                    }

                    <!-- Credit Card Payment -->
                    @if (selectedPaymentMethod() === 'credit-card') {
                        <div class="payment-content card-content">
                            <form class="card-form">
                                <div class="form-group">
                                    <label for="cardNumber">Número do Cartão</label>
                                    <input
                                        type="text"
                                        id="cardNumber"
                                        [(ngModel)]="cardNumber"
                                        name="cardNumber"
                                        (input)="formatCardNumber($event)"
                                        placeholder="1234 5678 9012 3456"
                                        maxlength="19">
                                </div>

                                <div class="form-group">
                                    <label for="cardName">Nome no Cartão</label>
                                    <input
                                        type="text"
                                        id="cardName"
                                        [(ngModel)]="cardName"
                                        name="cardName"
                                        placeholder="NOME COMPLETO"
                                        style="text-transform: uppercase;">
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="cardExpiry">Validade</label>
                                        <input
                                            type="text"
                                            id="cardExpiry"
                                            [(ngModel)]="cardExpiry"
                                            name="cardExpiry"
                                            (input)="formatExpiry($event)"
                                            placeholder="MM/AA"
                                            maxlength="5">
                                    </div>

                                    <div class="form-group">
                                        <label for="cardCvv">CVV</label>
                                        <input
                                            type="text"
                                            id="cardCvv"
                                            [(ngModel)]="cardCvv"
                                            name="cardCvv"
                                            placeholder="123"
                                            maxlength="3">
                                    </div>
                                </div>
                            </form>
                        </div>
                    }
                </div>

                <div class="modal-footer">
                    @if (selectedPaymentMethod() === 'credit-card') {
                        <button
                            class="btn-primary"
                            [disabled]="!isFormValid() || isProcessing()"
                            (click)="processPayment()">
                            @if (isProcessing()) {
                                <span class="spinner"></span>
                                Processando...
                            } @else {
                                Pagar R$ {{ product.salePrice.toFixed(2) }}
                            }
                        </button>
                    } @else {
                        <button
                            class="btn-primary"
                            [disabled]="isProcessing()"
                            (click)="processPayment()">
                            @if (isProcessing()) {
                                <span class="spinner"></span>
                                Confirmando...
                            } @else {
                                Confirmar Pagamento
                            }
                        </button>
                    }
                </div>
            } @else {
                <div class="success-message">
                    <div class="success-icon">
                        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="8 12 11 15 16 9"></polyline>
                        </svg>
                    </div>
                    <h2>Pagamento Confirmado!</h2>
                    <p>Obrigado pelo seu presente! ❤️</p>
                </div>
            }
        </div>
    </div>
}

